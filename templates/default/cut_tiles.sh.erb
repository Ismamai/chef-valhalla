#!/bin/bash
set -e

# make sure only one is running at any time...
LOCK_FILE="<%= node[:valhalla][:lock_dir] %>/cut_tiles.lock"
(set -C; : > ${LOCK_FILE}) 2> /dev/null
if [ $? != "0" ]; then
   echo "Lock file exists"
   exit 0
fi
trap 'rm $LOCK_FILE' EXIT 1 2 3

export PATH=$PATH:/usr/local/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib

tile_dir=$(jq -r '.mjolnir.hierarchy.tile_dir' <%= node[:valhalla][:config] %>)

#remove the hierarchy dirs.  if we crashed they are left around.
rm -rf ${tile_dir}/0
rm -rf ${tile_dir}/1
rm -rf ${tile_dir}/2

# name the dir where this will go
stamp=$(date +%Y_%m_%d-%H_%M_%S)

# things we need to make if we dont have them
extracts=$(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
admin_file=$(jq -r '.mjolnir.admin' <%= node[:valhalla][:config] %>)
timezone_file=$(jq -r '.mjolnir.timezone' <%= node[:valhalla][:config] %>)
if [ ! -e $admin_file ]; then
  valhalla_build_admins -c <%= node[:valhalla][:config] %> $(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
fi
if [ ! -e $timezone_file ]; then
  <%= node[:valhalla][:src_dir] %>/mjolnir/scripts/valhalla_build_timezones <%= node[:valhalla][:config] %>
fi

#transit data
if [ -f <%= node[:valhalla][:transit_dir] %>.tgz ]; then
  rm -rf <%= node[:valhalla][:transit_dir] %>
  mkdir <%= node[:valhalla][:transit_dir] %>
  tar pxvf <%= node[:valhalla][:transit_dir] %>.tgz -C <%= node[:valhalla][:transit_dir] %>
fi

# cut tiles from the data
valhalla_build_tiles -c <%= node[:valhalla][:config] %> $(find <%= node[:valhalla][:extracts_dir] %> -type f -name "*.pbf")
rm -rf *.bin
set +e

# package up the tiles and the admin and timezone dbs
cur_tile_dir=<%= node[:valhalla][:base_dir] %>/tiles_${stamp}
mkdir -p ${cur_tile_dir}
mv <%= node[:valhalla][:tile_dir] %>/* ${cur_tile_dir}/

# package up the extra stuff
cur_extras_dir=<%= node[:valhalla][:base_dir] %>/extras_${stamp}
mkdir -p ${cur_extras_dir}
pushd ${cur_extras_dir}
valhalla_build_connectivity -c <%= node[:valhalla][:config] %>
for f in connectivity*; do
  mv $f ${f%.*}_${stamp}.${f##*.}
done
stats_file=$(jq -r '.mjolnir.statistics' <%= node[:valhalla][:config] %>)
mv ${stats_file} $(basename ${stats_file} | sed -e "s/\(\.[^.]\+$\)/_${stamp}\1/g")
cp -rp <%= node[:valhalla][:transit_dir] %>.tgz <%= node[:valhalla][:transit_dir] %>_${stamp}.tgz
popd

# backup files and tile dirs, keep the admin and tz stuff though
cp -rp ${cur_tile_dir}/$(basename ${admin_file}) <%= node[:valhalla][:tile_dir] %>
cp -rp ${cur_tile_dir}/$(basename ${timezone_file}) <%= node[:valhalla][:tile_dir] %>

# do we want to send this update to s3 (do so in the background)
if [ "<%= node[:valhalla][:with_updates] %>" == true ]; then
  {
    tar pcf - -C ${cur_tile_dir} . | pigz -9 > ${cur_tile_dir}.tgz
    rm -rf ${cur_tile_dir} &
    <%= node[:valhalla][:conf_dir] %>/push_tiles.py ${cur_extras_dir}/* ${cur_tile_dir}.tgz
    rm -rf ${cur_extras_dir} ${cur_tile_dir}.tgz
  }&
fi
