#!/bin/bash

if [ -z $1 ]; then
	echo "No request provided"
	exit 1
fi

#keep checking while we havent run out of time
start=$(date +%s)
while [ $[$(date +%s) - $start] -lt <%= node[:valhalla][:health_check_timeout] %> ]; do
	curl localhost:<%= node[:valhalla][:httpd][:port] %>/route --max-time 1 --fail --data "${1}"
	if [ $? -eq 0 ]; then
		exit 0
	fi
	sleep 5
done

#never got a decent response try one last time
curl localhost:<%= node[:valhalla][:httpd][:port] %>/route --max-time 1 --fail --data "${1}"
exit $?
